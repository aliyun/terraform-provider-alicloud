name: Pull Request Process

on:
  pull_request:
    paths:
      - .github/workflows/pull_requests.yml
      - alicloud/*.go

jobs:
#  formatter:
#    name: Go Format Check
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@master
#        with:
#          fetch-depth: 0
#      - name: Golang Formatter
#        uses: Jerome1337/gofmt-action@v1.0.4
#        with:
#          gofmt-path: './alicloud'
#          gofmt-flags: '-l -d'
  formatter:
    name: Go Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          # Checkout as many commits as needed for the diff
          fetch-depth: 2
      - name: Set up Go Version
        uses: actions/setup-go@v2
        with:
          go-version: '1.19.3'

      - name: Get dependencies
        run: |
          go install golang.org/x/tools/cmd/goimports@latest
          go mod tidy
      - name: Golang Formatter Check
        run: |
          if [[ $(git diff --name-only HEAD^ HEAD | grep -c "^alicloud/") -lt 1 ]]; then
            echo -e "\033[33m[WARNING]\033[0m there are no go files were changed, skipped."
            exit 0
          fi
          exitCode=0
          echo "==> Checking that code complies with gofmt and goimports requirements..."
          diffFiles=$(git diff --name-only HEAD^ HEAD | grep "^alicloud/")
          for fileName in ${diffFiles[@]};
          do
              goimpFile=$(goimports -l ${fileName})
              if [[ -n ${goimpFile} ]]; then
                goimports -d ${fileName}
                exitCode=1
              fi
              gofmtFile=$(gofmt -l ${fileName})
              if [[ -n ${gofmtFile} ]]; then
                gofmt -d ${fileName}
                exitCode=1
              fi
          done
          if [[ ${exitCode} -gt 0 ]]; then
              echo -e "\n\033[31m[Error]\033[0m==> gofmt or goimports needs running on the above files. You can use the command: \`make fmt\` to reformat code. \033[0m"
              exit 1
          fi
          echo -e "==> PASS"

      - name: vet
        run: |
          make vet

  title:
    runs-on: ubuntu-latest
    name: PR Title Check
    steps:
      - uses: jitterbit/get-changed-files@v1
        id: files
        with:
          format: 'json'
      - name: Checking the title info
        run: |
          exitCode=0
          prTitle="${{ github.event.pull_request.title }}"
          echo -e "PR Title: \033[1m${prTitle}\033[0m"
          if [[ ${prTitle} == *"…" ]]; then
            echo -e "\nERROR: The PR title should not omit important infos about added or modified files. \033[1mxxx... is not recommended.\033[0m"
            exitCode=1
          fi
          readarray -t added_files <<<"$(jq -r '.[]' <<<'${{ steps.files.outputs.added }}')"
          for added_file in ${added_files[@]}; do
            if [[ ${added_file} == *?_test.go ]]; then
                continue
            fi
            if [[ ${added_file} == "alicloud/resource_alicloud"* ]]; then
                prefix="alicloud/resource_"
                suffix=".go"
                resourceName=${added_file}
                resourceName=${resourceName#"$prefix"}
                resourceName=${resourceName%"$suffix"}
                titleStr="New Resource: ${resourceName}"
                if [[ ${prTitle} != *"${titleStr}"* ]]; then
                  echo -e "\nERROR: The PR title should contains new resource info \033[1m${titleStr}\033[0m"
                  exitCode=1
                fi
            fi
            if [[ ${added_file} == "alicloud/data_source_alicloud"* ]]; then
                prefix="alicloud/data_source_"
                suffix=".go"
                resourceName=${added_file}
                resourceName=${resourceName#"$prefix"}
                resourceName=${resourceName%"$suffix"}
                titleStr="New Datasource: ${resourceName}"
                if [[ ${prTitle} != *"${titleStr}"* ]]; then
                  echo -e "\nERROR: The PR title should contains new datasource info \033[1m${titleStr}\033[0m"
                  exitCode=1
                fi
            fi
          done
          readarray -t modified_files <<<"$(jq -r '.[]' <<<'${{ steps.files.outputs.modified }}')"
          for modified_file in ${modified_files[@]}; do
            if [[ ${modified_file} == *?_test.go ]]; then
                continue
            fi
            if [[ ${modified_file} == "alicloud/resource_alicloud"* ]]; then
                prefix="alicloud/resource_"
                suffix=".go"
                resourceName=${modified_file}
                resourceName=${resourceName#"$prefix"}
                resourceName=${resourceName%"$suffix"}
                titleStr="resource/${resourceName}: "
                if [[ ${prTitle} != *"${titleStr}"* ]]; then
                  echo -e "\nERROR: The PR title should contains modified info like \033[1m${titleStr}xxx\033[0m"
                  exitCode=1
                fi
            fi
            if [[ ${modified_file} == "alicloud/data_source_alicloud"* ]]; then
                prefix="alicloud/data_source_"
                suffix=".go"
                resourceName=${modified_file}
                resourceName=${resourceName#"$prefix"}
                resourceName=${resourceName%"$suffix"}
                titleStr="datasource/${resourceName}: "
                if [[ ${prTitle} != *"${titleStr}"* ]]; then
                  echo -e "\nERROR: The PR title should contains modified info like \033[1m${titleStr}xxx\033[0m"
                  exitCode=1
                fi
            fi
          done

          exit ${exitCode}

  labeler:
    runs-on: ubuntu-latest
    name: Label the PR size
    steps:
      - uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_max_size: '30'
          s_max_size: '60'
          m_max_size: '150'
          l_max_size: '1500'
          fail_if_xl: 'false'
          message_if_xl: >
            'This PR exceeds the recommended size of 1500 lines.
            Please make sure you are NOT addressing multiple issues with one PR.
            Note this PR might be rejected due to its size.’