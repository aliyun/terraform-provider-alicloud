name: Terrafrom Basic Test Process
on:
  push:
    paths:
      - .github/workflows/acctest-terraform-basic.yml
      - alicloud/*.go
    branches:
      - master
  pull_request:
    paths:
      - .github/workflows/acctest-terraform-basic.yml
      - alicloud/*.go

jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Go Version
        uses: actions/setup-go@v2
        with:
          go-version: '1.19.3'

      - name: Get dependencies
        run: |
          go install golang.org/x/tools/cmd/goimports@latest
          go mod tidy

      - name: fmtcheck
        run: |
          make fmtcheck

      - name: importscheck
        run: |
          make importscheck

      - name: vet
        run: |
          make vet

#      - name: test
#        run: |
#          make test

  Integration-Test:
    runs-on: ubuntu-20.04
    environment: IntegrationTest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.18.x'
      - name: Use variables
        env:
          ALICLOUD_ACCESS_KEY: ${{ secrets.ALICLOUD_ACCESS_KEY }}
          ALICLOUD_SECRET_KEY: ${{ secrets.ALICLOUD_SECRET_KEY }}
          ALICLOUD_REGION: ${{ secrets.ALICLOUD_REGION }}
          TF_ACC: ${{ vars.TF_ACC }}
        run: |
          echo "TF variable : ${{ vars.TF_ACC }}"
          echo "region variable : ${{ secrets.ALICLOUD_REGION }}"
          echo "region: $ALICLOUD_REGION"
          go version
      - name: grant permissions
        run: |
          chmod +rwx scripts/attribute_compatibility_check.sh
          chmod +rwx scripts/attribute_consistency_check.sh
          chmod +rwx scripts/integration_test_check.sh
#          export TF_ACC=1
#      - name: Attribute Compatibility Check
#        run: |
#          sudo bash scripts/attribute_compatibility_check.sh
#      - name: Attribute Consistency Check
#        run: |
#          sudo bash scripts/attribute_consistency_check.sh
      - name: Integration Test Check
        env :
          ALICLOUD_ACCESS_KEY : ${{ secrets.ALICLOUD_ACCESS_KEY }}
          ALICLOUD_SECRET_KEY : ${{ secrets.ALICLOUD_SECRET_KEY }}
          ALICLOUD_REGION : ${{ secrets.ALICLOUD_REGION }}
          TF_ACC: ${{ vars.TF_ACC }}
          GIT_TRACE: 1
          GIT_CURL_VERBOSE: 1
        run: |
          sudo bash scripts/integration_test_check.sh